// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String  @id @default(uuid())
  email        String  @unique
  password     String? // Nullable for Google OAuth users
  name         String
  phone        String?
  profileImage String?
  points       Int     @default(100)
  bio          String?

  // Location
  locationAddress String?
  locationLat     Float?
  locationLng     Float?

  // OAuth
  googleId      String? @unique
  emailVerified Boolean @default(false)

  // Password Reset
  resetPasswordToken   String?
  resetPasswordExpires DateTime?

  // Relations
  books     Book[]
  exchanges Exchange[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([googleId])
}

model Book {
  id          String  @id @default(uuid())
  title       String
  author      String?
  isbn        String?
  description String?
  coverImage  String?
  qrCodeUrl   String? // QR code image URL from Cloudinary
  genre       String?
  condition   String? // e.g., "new", "excellent", "good", "fair", "poor"
  language    String? @default("English")
  pointValue  Int     @default(10) // Points required for exchange

  // Location
  locationAddress String?
  locationLat     Float?
  locationLng     Float?

  // Availability
  isAvailable Boolean @default(true)

  // Owner
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  exchanges   Exchange[]
  bookHistory BookHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isbn])
  @@index([isAvailable])
  @@index([genre])
}

model BookHistory {
  id     String  @id @default(uuid())
  bookId String
  book   Book    @relation(fields: [bookId], references: [id], onDelete: Cascade)
  userId String
  action String // "scanned", "noted", "exchanged", "read", "reviewed"
  notes  String?

  // Location
  locationAddress String?
  locationLat     Float?
  locationLng     Float?

  // Reading dates (for "read" action)
  startDate DateTime?
  endDate   DateTime?

  createdAt DateTime @default(now())

  @@index([bookId])
  @@index([userId])
  @@index([action])
}

model Exchange {
  id     String @id @default(uuid())
  status String @default("pending") // "pending", "accepted", "completed", "cancelled"

  // Book being exchanged
  bookId String
  book   Book   @relation(fields: [bookId], references: [id], onDelete: Cascade)

  // Users involved
  requesterId String
  requester   User   @relation(fields: [requesterId], references: [id], onDelete: Cascade)

  // Exchange details
  message        String?
  meetingAddress String?
  meetingLat     Float?
  meetingLng     Float?
  scheduledAt    DateTime?
  completedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bookId])
  @@index([requesterId])
  @@index([status])
}
